#!/usr/bin/env python

import XenAPI
import XenAPIPlugin
import sys
import urllib2
import base64
import subprocess
import os.path
from xml.dom.minidom import parseString

path          = "/opt/xensource/tpm/"
prg           = path + "xentpm"
aikblob       = path + "aiktpmblob"

xml_schema     = '<?xml version="1.0" encoding="UTF-8"?> \
<xentxt:xentxtdata xmlns:ds="http://www.w3.org/2000/09/xmldsig#" xmlns:xentxt="http://www.XenTxt.org/XenTxtGetAIK" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.XenTxt.org/XenTxtGetAIK xentxt.xsd "> \
  <xentxt:TPM_Endorsement_Certficate>MA==</xentxt:TPM_Endorsement_Certficate> \
  <xentxt:TPM_Endorsement_KEY_PEM>MA==</xentxt:TPM_Endorsement_KEY_PEM> \
  <xentxt:TPM_Attestation_KEY_PEM>MA==</xentxt:TPM_Attestation_KEY_PEM> \
   <xentxt:TPM_Attestation_KEY_TCPA>MA==</xentxt:TPM_Attestation_KEY_TCPA> \
</xentxt:xentxtdata>'

def doexec(args, inputtext=None):
    """Execute a subprocess, then return its return code, stdout and stderr"""
    proc = subprocess.Popen(args,stdin=subprocess.PIPE,stdout=subprocess.PIPE,stderr=subprocess.PIPE,close_fds=True)
    (stdout,stderr) = proc.communicate(inputtext)
    rc = proc.returncode
    return (rc,stdout,stderr)

def call_get_endorsementkey():
    (rc,stdout,stderr) = doexec([prg, "--get_ekey"])
    if rc != 0:
        raise Exception("Error: " + str(rc) + " getting the endorsement key")
    return stdout

def call_get_tpmcert():
    (rc,stdout,stderr) = doexec([prg, "--get_ekcert"])
    if rc != 0:
        raise Exception("Error: " + str(rc) + " getting the TPM certificate")
    return stdout

def call_get_aik_pem():
    (rc,stdout,stderr) = doexec([prg, "--get_aik_pem", aikblob])
    if rc != 0:
        raise Exception("Error: " + str(rc) + " getting the AIK PEM")
    return stdout

def call_get_aik_tcpa():
    (rc,stdout,stderr) = doexec([prg, "--get_aik_tcpa", aikblob])
    if rc != 0:
        raise Exception("Error: " + str(rc) + " getting the AIK TCPA Pub Key")
    return stdout

def call_gen_aik():
    xencert = ""
    (rc,xencert,stderr) = doexec(["xe", "host-get-server-certificate",])
    if rc != 0:
        xencert = ""

    (rc,stdout,stderr) = doexec([prg, "--gen_aik", aikblob, base64.b64encode(xencert)])
    if rc != 0:
        raise Exception("Error: " + str(rc) + " generation AIK")
    return stdout

def call_tpm_challenge(challenge):
    (rc,stdout,stderr) = doexec([prg, "--tpm_challenge", aikblob, challenge])
    if rc != 0:
        raise Exception("Error: " + str(rc) + " TPM challenge")
    return stdout

def call_tpm_quote(nonce):
    (rc,stdout,stderr) = doexec([prg, "--tpm_quote", nonce, aikblob])
    if rc != 0:
        raise Exception("Error: " + str(rc) + " getting TPM quote")
    return stdout

##Create an XML with
## certifciate, public keys

def tpm_get_attestation_identity(session, args):
    dom = parseString(xml_schema)
    root = dom.getElementsByTagName("xentxt:xentxtdata")
    tpmcert_node = dom.getElementsByTagName('xentxt:TPM_Endorsement_Certficate')[0]
    ekpub_node  = dom.getElementsByTagName("xentxt:TPM_Endorsement_KEY_PEM")[0]
    aikpub_node  = dom.getElementsByTagName("xentxt:TPM_Attestation_KEY_PEM")[0]
    aiktcp_node  = dom.getElementsByTagName("xentxt:TPM_Attestation_KEY_TCPA")[0]
    try:
        tpmcert_node.firstChild.nodeValue = call_get_tpmcert()
    except:
        tpmcert_node.firstChild.nodeValue = ''
    ekpub_node.firstChild.nodeValue = call_get_endorsementkey()
    if not os.path.isfile(aikblob) :
        call_gen_aik()
    aiktcp_node.firstChild.nodeValue = call_get_aik_tcpa()
    aikpub_node.firstChild.nodeValue = call_get_aik_pem()
    return dom.toxml()

def tpm_challenge(session, args):
    challenge = args['challenge']
    rc = call_tpm_challenge(challenge)
    return rc

def tpm_get_quote(session, args):
    nonce =  args['nonce']
    rc = call_tpm_quote(nonce)
    return rc

if __name__ == "__main__":
    XenAPIPlugin.dispatch({"tpm_get_attestation_identity": tpm_get_attestation_identity,
                           "tpm_challenge": tpm_challenge,
                           "tpm_get_quote": tpm_get_quote,
                           })
